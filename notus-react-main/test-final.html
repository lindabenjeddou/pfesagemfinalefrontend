<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - Notifications Magasinier</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .button { padding: 12px 20px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .button.danger { background: #dc3545; }
        .result { margin-top: 15px; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; white-space: pre-wrap; font-size: 12px; }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .step h3 { margin-top: 0; color: #007bff; }
        .logs { background: #000; color: #00ff00; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Test Final - Syst√®me de Notifications Magasinier</h1>
        
        <div class="step">
            <h3>üìã Instructions de Test</h3>
            <p>Ce test va v√©rifier si le syst√®me de notifications fonctionne correctement :</p>
            <ol>
                <li><strong>V√©rifier les magasiniers</strong> - Confirmer qu'il y a des utilisateurs avec le r√¥le MAGASINIER</li>
                <li><strong>Tester via le frontend React</strong> - Utiliser l'interface normale pour cr√©er un sous-projet</li>
                <li><strong>Surveiller les logs backend</strong> - V√©rifier que les notifications sont cr√©√©es</li>
                <li><strong>V√©rifier les notifications</strong> - Confirmer que les notifications apparaissent en base</li>
            </ol>
        </div>

        <div class="step">
            <h3>üîç √âtape 1: V√©rification des Magasiniers</h3>
            <button class="button" onclick="checkMagasiniers()">üë• V√©rifier Magasiniers</button>
            <div id="magasiniers-result"></div>
        </div>

        <div class="step">
            <h3>üöÄ √âtape 2: Instructions pour Test Frontend</h3>
            <div class="warning">
                <strong>‚ö†Ô∏è IMPORTANT:</strong> Pour tester la cr√©ation de sous-projet, suivez ces √©tapes :
                <ol>
                    <li>Ouvrez le frontend React : <a href="http://localhost:3000/admin/projet" target="_blank">http://localhost:3000/admin/projet</a></li>
                    <li>Cr√©ez un nouveau sous-projet avec au moins un composant</li>
                    <li>Surveillez la console du serveur backend pour voir les logs d√©taill√©s</li>
                    <li>Revenez ici pour v√©rifier les notifications cr√©√©es</li>
                </ol>
            </div>
        </div>

        <div class="step">
            <h3>üì¨ √âtape 3: V√©rification des Notifications</h3>
            <button class="button success" onclick="checkAllNotifications()">üì¨ V√©rifier Toutes les Notifications</button>
            <button class="button" onclick="checkRecentNotifications()">üïê Notifications R√©centes (5 min)</button>
            <div id="notifications-result"></div>
        </div>

        <div class="step">
            <h3>üîß √âtape 4: Diagnostic Complet</h3>
            <button class="button" onclick="runFullDiagnostic()">üîç Diagnostic Complet</button>
            <div id="diagnostic-result"></div>
        </div>

        <div class="step">
            <h3>üìä Logs Backend Attendus</h3>
            <div class="logs">
üîç === D√âBUT SAUVEGARDE SOUS-PROJET ===
‚úÖ SousProjet created successfully with ID: X
üîç Nom du sous-projet: Test Notification
üîç Nombre de composants: 1
üîç === D√âBUT ENVOI NOTIFICATIONS ===
üîî Appel notifyMagasiniersForSousProjetCreation...
‚úÖ notifyMagasiniersForSousProjetCreation termin√©
üîî Appel notifyMagasiniersForComponentOrder avec 1 composants...
‚úÖ notifyMagasiniersForComponentOrder termin√©
‚úÖ TOUTES LES NOTIFICATIONS ENVOY√âES pour le sous-projet: X
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8089/PI';
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="result ${type}">
                    <strong>R√©sultat (${new Date().toLocaleTimeString()}):</strong>
                    <pre>${typeof message === 'object' ? JSON.stringify(message, null, 2) : message}</pre>
                </div>
            `;
        }
        
        async function makeRequest(url, options = {}) {
            try {
                console.log('üîç Requ√™te vers:', url);
                const response = await fetch(url, {
                    mode: 'cors',
                    credentials: 'omit',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    ...options
                });
                
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    data = text;
                }
                
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                return { success: false, error: error.message, errorType: error.name };
            }
        }
        
        async function checkMagasiniers() {
            showResult('magasiniers-result', 'üîÑ V√©rification des magasiniers...', 'info');
            
            const result = await makeRequest(`${API_BASE}/user/all`);
            
            if (result.success && Array.isArray(result.data)) {
                const magasiniers = result.data.filter(user => 
                    user.role === 'MAGASINIER' || user.role === 'Magasinier'
                );
                
                const message = {
                    status: '‚úÖ Magasiniers trouv√©s',
                    totalUsers: result.data.length,
                    magasiniersCount: magasiniers.length,
                    magasiniers: magasiniers.map(m => ({
                        id: m.id,
                        nom: `${m.firstName} ${m.lastName}`,
                        email: m.email,
                        role: m.role
                    })),
                    nextStep: magasiniers.length > 0 ? 
                        '‚úÖ Vous pouvez maintenant cr√©er un sous-projet via le frontend React' :
                        '‚ùå PROBL√àME: Aucun magasinier trouv√© - les notifications ne peuvent pas √™tre envoy√©es'
                };
                
                showResult('magasiniers-result', message, magasiniers.length > 0 ? 'success' : 'error');
            } else {
                showResult('magasiniers-result', {
                    error: '‚ùå Impossible de r√©cup√©rer les utilisateurs',
                    details: result
                }, 'error');
            }
        }
        
        async function checkAllNotifications() {
            showResult('notifications-result', 'üîÑ V√©rification de toutes les notifications...', 'info');
            
            // D'abord r√©cup√©rer les magasiniers
            const usersResult = await makeRequest(`${API_BASE}/user/all`);
            
            if (!usersResult.success) {
                showResult('notifications-result', '‚ùå Impossible de r√©cup√©rer les utilisateurs', 'error');
                return;
            }
            
            const magasiniers = usersResult.data.filter(user => 
                user.role === 'MAGASINIER' || user.role === 'Magasinier'
            );
            
            if (magasiniers.length === 0) {
                showResult('notifications-result', '‚ùå Aucun magasinier trouv√©', 'error');
                return;
            }
            
            // V√©rifier les notifications pour chaque magasinier
            const notificationResults = [];
            let totalNotifications = 0;
            
            for (const magasinier of magasiniers) {
                const notifResult = await makeRequest(`${API_BASE}/notifications/user/${magasinier.id}`);
                const notifications = notifResult.success && Array.isArray(notifResult.data) ? notifResult.data : [];
                
                notificationResults.push({
                    magasinier: `${magasinier.firstName} ${magasinier.lastName} (ID: ${magasinier.id})`,
                    notificationsCount: notifications.length,
                    notifications: notifications.map(n => ({
                        id: n.id,
                        title: n.title,
                        message: n.message,
                        type: n.type,
                        isRead: n.isRead,
                        createdAt: n.createdAt || 'Date non disponible'
                    }))
                });
                
                totalNotifications += notifications.length;
            }
            
            const message = {
                status: totalNotifications > 0 ? '‚úÖ Notifications trouv√©es' : '‚ö†Ô∏è Aucune notification trouv√©e',
                magasiniersCount: magasiniers.length,
                totalNotifications: totalNotifications,
                details: notificationResults,
                recommendation: totalNotifications === 0 ? 
                    'Cr√©ez un sous-projet via le frontend React et v√©rifiez les logs backend' :
                    'Les notifications fonctionnent correctement !'
            };
            
            showResult('notifications-result', message, totalNotifications > 0 ? 'success' : 'warning');
        }
        
        async function checkRecentNotifications() {
            showResult('notifications-result', 'üîÑ V√©rification des notifications r√©centes...', 'info');
            
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
            
            // R√©cup√©rer toutes les notifications et filtrer les r√©centes
            await checkAllNotifications();
            
            // Note: Le filtrage par date n√©cessiterait une modification du backend
            // Pour l'instant, on affiche toutes les notifications avec un avertissement
            setTimeout(() => {
                const currentResult = document.getElementById('notifications-result').innerHTML;
                document.getElementById('notifications-result').innerHTML = currentResult + 
                    '<div class="result info"><strong>Note:</strong> Filtrage par date non impl√©ment√© c√¥t√© backend. Toutes les notifications sont affich√©es.</div>';
            }, 1000);
        }
        
        async function runFullDiagnostic() {
            showResult('diagnostic-result', 'üîÑ Diagnostic complet en cours...', 'info');
            
            const diagnostic = {
                timestamp: new Date().toISOString(),
                tests: []
            };
            
            // Test 1: V√©rifier la connectivit√© backend
            try {
                const healthCheck = await makeRequest(`${API_BASE}/user/all`);
                diagnostic.tests.push({
                    test: 'Connectivit√© Backend',
                    status: healthCheck.success ? '‚úÖ OK' : '‚ùå √âCHEC',
                    details: healthCheck.success ? 'Backend accessible' : healthCheck.error
                });
            } catch (e) {
                diagnostic.tests.push({
                    test: 'Connectivit√© Backend',
                    status: '‚ùå √âCHEC',
                    details: e.message
                });
            }
            
            // Test 2: V√©rifier les magasiniers
            try {
                const usersResult = await makeRequest(`${API_BASE}/user/all`);
                const magasiniers = usersResult.success ? 
                    usersResult.data.filter(u => u.role === 'MAGASINIER' || u.role === 'Magasinier') : [];
                
                diagnostic.tests.push({
                    test: 'Magasiniers Disponibles',
                    status: magasiniers.length > 0 ? '‚úÖ OK' : '‚ùå √âCHEC',
                    details: `${magasiniers.length} magasinier(s) trouv√©(s)`
                });
            } catch (e) {
                diagnostic.tests.push({
                    test: 'Magasiniers Disponibles',
                    status: '‚ùå √âCHEC',
                    details: e.message
                });
            }
            
            // Test 3: V√©rifier les projets
            try {
                const projectsResult = await makeRequest(`${API_BASE}/projects/all`);
                diagnostic.tests.push({
                    test: 'Projets Disponibles',
                    status: projectsResult.success ? '‚úÖ OK' : '‚ùå √âCHEC',
                    details: projectsResult.success ? 
                        `${Array.isArray(projectsResult.data) ? projectsResult.data.length : 'N/A'} projet(s)` : 
                        projectsResult.error
                });
            } catch (e) {
                diagnostic.tests.push({
                    test: 'Projets Disponibles',
                    status: '‚ö†Ô∏è AVERTISSEMENT',
                    details: 'Endpoint projets non accessible (normal si aucun projet)'
                });
            }
            
            diagnostic.summary = {
                allTestsPassed: diagnostic.tests.every(t => t.status.includes('‚úÖ')),
                readyForTesting: diagnostic.tests.filter(t => t.status.includes('‚úÖ')).length >= 2
            };
            
            diagnostic.recommendations = [
                'Si tous les tests passent, cr√©ez un sous-projet via http://localhost:3000/admin/projet',
                'Surveillez la console du serveur backend pour voir les logs d√©taill√©s',
                'Revenez ici pour v√©rifier que les notifications ont √©t√© cr√©√©es',
                'Si aucune notification n\'appara√Æt, v√©rifiez les logs backend pour identifier le probl√®me'
            ];
            
            showResult('diagnostic-result', diagnostic, 
                diagnostic.summary.allTestsPassed ? 'success' : 'warning');
        }
        
        // Auto-diagnostic au chargement
        window.onload = function() {
            checkMagasiniers();
        };
    </script>
</body>
</html>
